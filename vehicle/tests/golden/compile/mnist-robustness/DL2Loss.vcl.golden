bigAnd : (\ A -> Vector A) Rat -> Rat;
bigAnd = (\ {A} -> \ {B} -> \ f -> dfold f) (\ x -> \ y -> x + y) 0.0

vectorToVector : Vector Rat -> Vector Rat;
vectorToVector xs = xs

mapVector : (Index -> Rat) -> Vector (Index) -> Vector Rat;
mapVector f = dfold {Index} {Vector Rat} (\ x -> \ xs -> f x :: xs) []

foreachVector : forallT n . (Index -> Rat) -> Vector Rat;
foreachVector n f = mapVector f (indices n)

@noinline;
subVector : Vector Rat -> Vector Rat -> Vector Rat;
subVector = zipWith (\ x -> \ y -> x - y)

@noinline;
subVector : Vector (Vector Rat) -> Vector (Vector Rat) -> Vector (Vector Rat);
subVector = zipWith (\ x -> \ y -> subVector x y)

forallIndex : forallT n . (Index -> Rat) -> Rat;
forallIndex n f = bigAnd (foreachVector n (\ i -> f i))

type Tensor A ds = fold (\ d -> \ t -> Vector t) A ds

vectorToList : Vector Nat -> List Nat;
vectorToList = (\ {A} -> \ {B} -> \ f -> dfold f) (\ x -> \ xs -> x :: xs) nil

mapList : (Vector (Vector Rat) -> Rat) -> List (Vector (Vector Rat)) -> List Rat;
mapList f = fold (\ x -> \ xs -> f x :: xs) nil

type Image = Tensor Rat (28 :: 28 :: nil)

type Label = Index

validImage : Image -> Rat;
validImage x = forallIndex 28 (\ i -> forallIndex 28 (\ j -> max 0.0 (0.0 - x ! i ! j) + max 0.0 (x ! i ! j - 1.0)))

advises : forallT (classifier : Image -> Vector Rat) . Image -> Label -> Rat;
advises classifier x i = forallIndex 10 (\ j -> max 0.0 ((if j != i then 0.0 else 1.0) * (max 0.0 (classifier x ! j - classifier x ! i) + (if classifier x ! j == classifier x ! i then 1.0 else 0.0))))

boundedByEpsilon : forallT (epsilon : Rat) . Image -> Rat;
boundedByEpsilon epsilon x = forallIndex 28 (\ i -> forallIndex 28 (\ j -> max 0.0 (- epsilon - x ! i ! j) + max 0.0 (x ! i ! j - epsilon)))

robustAround : forallT (classifier : Image -> Vector Rat) . forallT (epsilon : Rat) . Image -> Label -> Rat;
robustAround classifier epsilon image label = bigAnd (mapList (\ pertubation -> let perturbedImage = subVector image pertubation in max 0.0 ((boundedByEpsilon epsilon pertubation + validImage perturbedImage) * advises classifier perturbedImage label)) sample[pertubation][label, image, epsilon, classifier])

@property;
robust : forallT (classifier : Image -> Vector Rat) . forallT (epsilon : Rat) . forallT (n : Nat) . forallT (trainingImages : Vector Image) . forallT (trainingLabels : Vector Label) . Vector Rat;
robust classifier epsilon n trainingImages trainingLabels = foreachVector n (\ i -> robustAround classifier epsilon (trainingImages ! i) (trainingLabels ! i))